<?xml version="1.0" encoding="UTF-8"?>
<!--
  ~ Copyright © FYLAB and the Conseil Régional d'Île-de-France, 2009
  ~ This file is part of L'Interface Libre et Interactive de l'Enseignement (Lilie).
  ~
  ~ Lilie is free software. You can redistribute it and/or modify since
  ~ you respect the terms of either (at least one of the both license) :
  ~ - under the terms of the GNU Affero General Public License as
  ~ published by the Free Software Foundation, either version 3 of the
  ~ License, or (at your option) any later version.
  ~ - the CeCILL-C as published by CeCILL-C; either version 1 of the
  ~ License, or any later version
  ~
  ~ There are special exceptions to the terms and conditions of the
  ~ licenses as they are applied to this software. View the full text of
  ~ the exception in file LICENSE.txt in the directory of this software
  ~ distribution.
  ~
  ~ Lilie is distributed in the hope that it will be useful,
  ~ but WITHOUT ANY WARRANTY; without even the implied warranty of
  ~ MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  ~ Licenses for more details.
  ~
  ~ You should have received a copy of the GNU General Public License
  ~ and the CeCILL-C along with Lilie. If not, see :
  ~  <http://www.gnu.org/licenses/> and
  ~  <http://www.cecill.info/licences.fr.html>.
  -->

<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">

    <changeSet id="0" author="fsil">
        <comment>
            Entitées d'abord utiles a tdbase mais pouvant être utiles à d'autre
            modules
        </comment>

        <createTable tableName="export_format" schemaName="tice">
            <column name="id" type="bigint">
                <constraints primaryKey="true"/>
            </column>
            <column name="nom" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createSequence sequenceName="export_format_id_seq" schemaName="tice"
                        startValue="100"/>

        <createTable tableName="attachement" schemaName="tice">
            <column name="id" type="bigint">
                <constraints primaryKey="true"/>
            </column>
            <column name="chemin" type="text">
                <constraints nullable="false"/>
            </column>
            <column name="nom" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="taille_en_ko" type="bigint"/>
            <column name="type_mime" type="varchar(255)"/>
        </createTable>

        <createSequence
                sequenceName="attachement_id_seq"
                schemaName="tice"
                startValue="100"/>

    </changeSet>

    <changeSet id="1" author="fsil">
        <comment>
            Création du schéma pour tdbase (td) puis de la table question
            avec relations associées
        </comment>

        <sql>create schema td;</sql>

        <createTable tableName="question_type" schemaName="td">
            <column name="id" type="bigint">
                <constraints primaryKey="true"/>
            </column>
            <column name="nom" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="nom_anglais" type="varchar(255)"/>
        </createTable>

        <createSequence sequenceName="question_type_id_seq"
                        schemaName="td" startValue="100"/>

        <createTable tableName="question" schemaName="td">
            <column name="id" type="bigint">
                <constraints primaryKey="true"/>
            </column>
            <column name="titre" type="text">
                <constraints nullable="false"/>
            </column>
            <column name="est_autonome" type="boolean" defaultValue="true">
                <constraints nullable="false"/>
            </column>
            <column name="specification" type="text">
                <constraints nullable="false"/>
            </column>
            <column name="version_question" type="int" defaultValue="1">
                <constraints nullable="false"/>
            </column>
            <column name="type_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="proprietaire_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="matiere_id" type="bigint"/>
            <column name="etablissement_id" type="bigint"/>
            <column name="niveau_id" type="bigint"/>

        </createTable>

        <createSequence sequenceName="question_id_seq"
                        schemaName="td"
                        startValue="100"/>

        <addForeignKeyConstraint baseTableName="question"
                                 baseColumnNames="niveau_id"
                                 baseTableSchemaName="td"
                                 constraintName="fk_question_niveau_id"
                                 referencedTableName="niveau"
                                 referencedColumnNames="id"
                                 referencedTableSchemaName="ent"/>

        <createIndex tableName="question"
                     indexName="idx_question_niveau_id"
                     schemaName="td">
            <column name="niveau_id"/>
        </createIndex>

        <addForeignKeyConstraint baseTableName="question"
                                 baseColumnNames="etablissement_id"
                                 baseTableSchemaName="td"
                                 constraintName="fk_question_etablissement_id"
                                 referencedTableName="etablissement"
                                 referencedColumnNames="id"
                                 referencedTableSchemaName="ent"/>

        <createIndex tableName="question"
                     indexName="idx_question_etablissement_id"
                     schemaName="td">
            <column name="etablissement_id"/>
        </createIndex>

        <addForeignKeyConstraint baseTableName="question"
                                 baseColumnNames="matiere_id"
                                 baseTableSchemaName="td"
                                 constraintName="fk_question_matiere_id"
                                 referencedTableName="matiere"
                                 referencedColumnNames="id"
                                 referencedTableSchemaName="ent"/>

        <createIndex tableName="question"
                     indexName="idx_question_matiere_id"
                     schemaName="td">
            <column name="matiere_id"/>
        </createIndex>

        <addForeignKeyConstraint baseTableName="question"
                                 baseColumnNames="type_id"
                                 baseTableSchemaName="td"
                                 constraintName="fk_question_type_id"
                                 referencedTableName="question_type"
                                 referencedColumnNames="id"
                                 referencedTableSchemaName="td"
                />
        <createIndex tableName="question"
                     indexName="idx_question_type_id"
                     schemaName="td">
            <column name="type_id"/>
        </createIndex>


        <addForeignKeyConstraint baseTableName="question"
                                 baseColumnNames="proprietaire_id"
                                 baseTableSchemaName="td"
                                 constraintName="fk_question_proprietaire_id"
                                 referencedTableName="personne"
                                 referencedColumnNames="id"
                                 referencedTableSchemaName="ent"/>

        <createIndex tableName="question"
                     indexName="idx_question_proprietaire_id"
                     schemaName="td">
            <column name="proprietaire_id"/>
        </createIndex>


        <createTable tableName="question_export" schemaName="td">
            <column name="id" type="bigint">
                <constraints primaryKey="true"/>
            </column>
            <column name="format_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="export" type="text">
                <constraints nullable="false"/>
            </column>
            <column name="question_id" type="bigint">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createSequence sequenceName="question_export_id_seq"
                        schemaName="td"
                        startValue="100"/>

        <addForeignKeyConstraint baseTableName="question_export"
                                 baseColumnNames="format_id"
                                 baseTableSchemaName="td"
                                 constraintName="fk_question_export_format_id"
                                 referencedTableName="export_format"
                                 referencedColumnNames="id"
                                 referencedTableSchemaName="tice"/>

        <createIndex tableName="question_export"
                     indexName="idx_question_export_format_id"
                     schemaName="td">
            <column name="format_id"/>
        </createIndex>

        <addForeignKeyConstraint baseTableName="question_export"
                                 baseColumnNames="question_id"
                                 baseTableSchemaName="td"
                                 constraintName="fk_question_export_question_id"
                                 referencedTableName="question"
                                 referencedColumnNames="id"
                                 referencedTableSchemaName="td"/>

        <createIndex tableName="question_export"
                     indexName="idx_question_export_question_id"
                     schemaName="td">
            <column name="question_id"/>
        </createIndex>

        <createTable tableName="question_attachement" schemaName="td">
            <column name="id" type="bigint">
                <constraints primaryKey="true"/>
            </column>
            <column name="question_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="attachement_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="rang" type="int" defaultValue="1"/>
        </createTable>

        <createSequence sequenceName="question_attachement_id_seq"
                        schemaName="td"
                        startValue="100"/>

        <addForeignKeyConstraint baseTableName="question_attachement"
                                 baseColumnNames="attachement_id"
                                 baseTableSchemaName="td"
                                 constraintName="fk_question_attachement_attachement_id"
                                 referencedTableName="attachement"
                                 referencedColumnNames="id"
                                 referencedTableSchemaName="tice"/>

        <createIndex tableName="question_attachement"
                     indexName="idx_question_attachement_attachement_id"
                     schemaName="td">
            <column name="attachement_id"/>
        </createIndex>

        <addForeignKeyConstraint baseTableName="question_attachement"
                                 baseColumnNames="question_id"
                                 baseTableSchemaName="td"
                                 constraintName="fk_question_attachement_question_id"
                                 referencedTableName="question"
                                 referencedColumnNames="id"
                                 referencedTableSchemaName="td"/>

        <createIndex tableName="question_attachement"
                     indexName="idx_question_attachement_question_id"
                     schemaName="td">
            <column name="question_id"/>
        </createIndex>


        <createTable tableName="question_arborescence" schemaName="td">
            <column name="id" type="bigint">
                <constraints primaryKey="true"/>
            </column>
            <column name="question_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="question_fille_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="rang" type="int">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createSequence sequenceName="question_arborescence_id_seq"
                        schemaName="td"
                        startValue="100"/>

        <addForeignKeyConstraint baseTableName="question_arborescence"
                                 baseColumnNames="question_id"
                                 baseTableSchemaName="td"
                                 constraintName="fk_question_arboresence_question_id"
                                 referencedTableName="question"
                                 referencedColumnNames="id"
                                 referencedTableSchemaName="td"/>

        <createIndex tableName="question_arborescence"
                     indexName="idx_question_arborescence_question_id"
                     schemaName="td">
            <column name="question_id"/>
        </createIndex>

        <addForeignKeyConstraint baseTableName="question_arborescence"
                                 baseColumnNames="question_fille_id"
                                 baseTableSchemaName="td"
                                 constraintName="fk_question_arboresence_question_fille_id"
                                 referencedTableName="question"
                                 referencedColumnNames="id"
                                 referencedTableSchemaName="td"/>

        <createIndex tableName="question_arborescence"
                     indexName="idx_question_arborescence_question_fille_id"
                     schemaName="td">
            <column name="question_fille_id"/>
        </createIndex>
    </changeSet>

    <changeSet id="2" author="fsil">
        <comment>
            Ajout des tables autour de la notion de sujet avec relations
            associées
        </comment>

        <createTable tableName="sujet" schemaName="td">
            <column name="id" type="bigint">
                <constraints primaryKey="true"/>
            </column>
            <column name="titre" type="text">
                <constraints nullable="false"/>
            </column>
            <column name="version_sujet" type="int" defaultValue="1">
                <constraints nullable="false"/>
            </column>
            <column name="proprietaire_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="matiere_id" type="bigint"/>
            <column name="etablissement_id" type="bigint"/>
            <column name="niveau_id" type="bigint"/>
            <column name="duree_minutes" type="int"/>
            <column name="presentation" type="text"/>
            <column name="note_max" type="float"/>
            <column name="note_auto_max" type="float"/>
            <column name="note_enseignant_max" type="float"/>
            <column name="nb_questions" type="int"/>

        </createTable>

        <createSequence sequenceName="sujet_id_seq"
                        schemaName="td"
                        startValue="100"/>

        <addForeignKeyConstraint baseTableName="sujet"
                                 baseColumnNames="niveau_id"
                                 baseTableSchemaName="td"
                                 constraintName="fk_sujet_niveau_id"
                                 referencedTableName="niveau"
                                 referencedColumnNames="id"
                                 referencedTableSchemaName="ent"/>

        <createIndex tableName="sujet"
                     indexName="idx_sujet_niveau_id"
                     schemaName="td">
            <column name="niveau_id"/>
        </createIndex>

        <addForeignKeyConstraint baseTableName="sujet"
                                 baseColumnNames="etablissement_id"
                                 baseTableSchemaName="td"
                                 constraintName="fk_sujet_etablissement_id"
                                 referencedTableName="etablissement"
                                 referencedColumnNames="id"
                                 referencedTableSchemaName="ent"/>

        <createIndex tableName="sujet"
                     indexName="idx_sujet_etablissement_id"
                     schemaName="td">
            <column name="etablissement_id"/>
        </createIndex>

        <addForeignKeyConstraint baseTableName="sujet"
                                 baseColumnNames="matiere_id"
                                 baseTableSchemaName="td"
                                 constraintName="fk_sujet_matiere_id"
                                 referencedTableName="matiere"
                                 referencedColumnNames="id"
                                 referencedTableSchemaName="ent"/>

        <createIndex tableName="sujet"
                     indexName="idx_sujet_matiere_id"
                     schemaName="td">
            <column name="matiere_id"/>
        </createIndex>

        <addForeignKeyConstraint baseTableName="sujet"
                                 baseColumnNames="proprietaire_id"
                                 baseTableSchemaName="td"
                                 constraintName="fk_sujet_proprietaire_id"
                                 referencedTableName="personne"
                                 referencedColumnNames="id"
                                 referencedTableSchemaName="ent"/>

        <createIndex tableName="sujet"
                     indexName="idx_sujet_proprietaire_id"
                     schemaName="td">
            <column name="proprietaire_id"/>
        </createIndex>

        <createTable tableName="sujet_sequence_questions" schemaName="td">
            <column name="id" type="bigint">
                <constraints primaryKey="true"/>
            </column>
            <column name="sujet_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="question_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="rang" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="note_seuil_poursuite" type="float"/>
        </createTable>

        <createSequence sequenceName="sujet_sequence_questions_id_seq"
                        schemaName="td"
                        startValue="100"/>

        <addForeignKeyConstraint baseTableName="sujet_sequence_questions"
                                 baseColumnNames="sujet_id"
                                 baseTableSchemaName="td"
                                 constraintName="fk_sujet_sequence_questions_sujet_id"
                                 referencedTableName="sujet"
                                 referencedColumnNames="id"
                                 referencedTableSchemaName="td"/>

        <createIndex tableName="sujet_sequence_questions"
                     indexName="idx_sujet_sequence_questions_sujet_id"
                     schemaName="td">
            <column name="sujet_id"/>
        </createIndex>

        <addForeignKeyConstraint baseTableName="sujet_sequence_questions"
                                 baseColumnNames="question_id"
                                 baseTableSchemaName="td"
                                 constraintName="fk_sujet_sequence_questions_question_id"
                                 referencedTableName="question"
                                 referencedColumnNames="id"
                                 referencedTableSchemaName="td"/>

        <createIndex tableName="sujet_sequence_questions"
                     indexName="idx_sujet_sequence_questions_question_id"
                     schemaName="td">
            <column name="question_id"/>
        </createIndex>
    </changeSet>

    <changeSet id="3" author="fsil">
        <comment>
            Gestion des copyrigths
        </comment>

        <createTable tableName="copyrigths_type" schemaName="tice">
            <column name="id" type="bigint">
                <constraints primaryKey="true"/>
            </column>
            <column name="code" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="presentation" type="text"/>
            <column name="lien" type="text"/>
            <column name="logo" type="bytea"/>

            <!--reprise des options creative commons-->
            <column name="option_cc_paternite"
                    type="boolean" defaultValue="true"/>
            <column name="option_cc_pas_utilisation_commerciale"
                    type="boolean" defaultValue="true"/>
            <column name="option_cc_pas_modification"
                    type="boolean" defaultValue="false"/>
            <column name="option_cc_partage_viral"
                    type="boolean" defaultValue="true"/>

            <!-- dans ce cas, droits d'auteur par défaut, c'est privé -->
            <column name="option_tous_droits_reserves"
                    type="boolean" defaultValue="false"/>

        </createTable>

        <createSequence sequenceName="copyrigths_type_id_seq"
                        schemaName="tice" startValue="100"/>

        <createTable tableName="publication" schemaName="tice">
            <column name="id" type="bigint">
                <constraints primaryKey="true"/>
            </column>
            <column name="copyrigths_type_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="date_debut" type="timestamp without time zone">
                <constraints nullable="false"/>
            </column>
            <column name="date_fin" type="timestamp without time zone">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createSequence sequenceName="publication_id_seq"
                        schemaName="tice" startValue="100"/>

        <addForeignKeyConstraint baseTableName="publication"
                                 baseColumnNames="copyrigths_type_id"
                                 baseTableSchemaName="tice"
                                 constraintName="fk_publication_copyrights_type_id"
                                 referencedTableName="copyrigths_type"
                                 referencedColumnNames="id"
                                 referencedTableSchemaName="tice"/>

        <createIndex tableName="publication"
                     indexName="idx_publication_copyrights_type_id"
                     schemaName="tice">
            <column name="copyrigths_type_id"/>
        </createIndex>

        <addColumn tableName="question" schemaName="td">
            <column name="publication_id" type="bigint"/>
        </addColumn>

        <addColumn tableName="sujet" schemaName="td">
            <column name="publication_id" type="bigint"/>
        </addColumn>

        <addForeignKeyConstraint baseTableName="question"
                                 baseColumnNames="publication_id"
                                 baseTableSchemaName="td"
                                 constraintName="fk_question_publication_id"
                                 referencedTableName="publication"
                                 referencedColumnNames="id"
                                 referencedTableSchemaName="tice"/>

        <createIndex tableName="question"
                     indexName="idx_question_publication_id"
                     schemaName="td">
            <column name="publication_id"/>
        </createIndex>

        <addForeignKeyConstraint baseTableName="sujet"
                                 baseColumnNames="publication_id"
                                 baseTableSchemaName="td"
                                 constraintName="fk_sujet_publication_id"
                                 referencedTableName="publication"
                                 referencedColumnNames="id"
                                 referencedTableSchemaName="tice"/>

        <createIndex tableName="sujet"
                     indexName="idx_sujet_publication_id"
                     schemaName="td">
            <column name="publication_id"/>
        </createIndex>

    </changeSet>

    <changeSet id="4" author="fsil">
        <comment>
            Ajout de quelques clés uniques manquantes sur les tables
            de jointures
        </comment>
        <addUniqueConstraint tableName="question_arborescence"
                             columnNames="question_id, question_fille_id"
                             constraintName="uk_question_arborescence_question_id_question_fille_id"
                             schemaName="td"/>

        <addUniqueConstraint tableName="question_attachement"
                             columnNames="question_id, attachement_id"
                             constraintName="uk_question_attachement_question_id_attachement_id"
                             schemaName="td"/>

        <addUniqueConstraint tableName="sujet_sequence_questions"
                             columnNames="question_id, sujet_id"
                             constraintName="uk_sujet_sequence_questions_question_id_sujet_id"
                             schemaName="td"/>


    </changeSet>

    <changeSet id="5" author="fsil">
        <comment>
            Gestion des séances, copies, réponses, corrections...
        </comment>

        <createSequence sequenceName="copie_id_seq"
                        schemaName="td" startValue="100"/>

        <createTable tableName="copie" schemaName="td">
            <column name="id" type="bigint">
                <constraints primaryKey="true"/>
            </column>
            <column name="date_remise" type="timestamp without time zone">
                <constraints nullable="false"/>
            </column>
            <column name="sujet_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="eleve_id" type="bigint"/>
            <column name="correcteur_id" type="bigint"/>
            <column name="correction_date" type="timestamp without time zone"/>
            <column name="correction_annotation" type="text"/>
            <column name="correction_note_automatique" type="float"/>
            <column name="correction_note_finale" type="float"/>
        </createTable>

        <addForeignKeyConstraint baseTableName="copie"
                                 baseColumnNames="sujet_id"
                                 baseTableSchemaName="td"
                                 constraintName="fk_copie_sujet_id"
                                 referencedTableName="sujet"
                                 referencedColumnNames="id"
                                 referencedTableSchemaName="td"/>

        <createIndex tableName="copie"
                     indexName="idx_copie_sujet_id"
                     schemaName="td">
            <column name="sujet_id"/>
        </createIndex>

        <addForeignKeyConstraint baseTableName="copie"
                                 baseColumnNames="eleve_id"
                                 baseTableSchemaName="td"
                                 constraintName="fk_copie_eleve_id"
                                 referencedTableName="personne"
                                 referencedColumnNames="id"
                                 referencedTableSchemaName="ent"/>

        <createIndex tableName="copie"
                     indexName="idx_copie_eleve_id"
                     schemaName="td">
            <column name="eleve_id"/>
        </createIndex>

        <addForeignKeyConstraint baseTableName="copie"
                                 baseColumnNames="correcteur_id"
                                 baseTableSchemaName="td"
                                 constraintName="fk_copie_correcteur_id"
                                 referencedTableName="personne"
                                 referencedColumnNames="id"
                                 referencedTableSchemaName="ent"/>

        <createIndex tableName="copie"
                     indexName="idx_copie_correcteur_id"
                     schemaName="td">
            <column name="correcteur_id"/>
        </createIndex>

        <createSequence sequenceName="reponse_id_seq"
                        schemaName="td" startValue="100"/>

        <createTable tableName="reponse" schemaName="td">
            <column name="id" type="bigint">
                <constraints primaryKey="true"/>
            </column>
            <column name="specification" type="text"/>
            <column name="copie_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="question_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="correcteur_id" type="bigint"/>
            <column name="correction_date" type="timestamp without time zone"/>
            <column name="correction_annotation" type="text"/>
            <column name="correction_note_automatique" type="float"/>
            <column name="correction_note_finale" type="float"/>
        </createTable>

        <addForeignKeyConstraint baseTableName="reponse"
                                 baseColumnNames="copie_id"
                                 baseTableSchemaName="td"
                                 constraintName="fk_reponse_copie_id"
                                 referencedTableName="copie"
                                 referencedColumnNames="id"
                                 referencedTableSchemaName="td"/>

        <createIndex tableName="reponse"
                     indexName="idx_reponse_copie_id"
                     schemaName="td">
            <column name="copie_id"/>
        </createIndex>

        <addForeignKeyConstraint baseTableName="reponse"
                                 baseColumnNames="question_id"
                                 baseTableSchemaName="td"
                                 constraintName="fk_reponse_question_id"
                                 referencedTableName="question"
                                 referencedColumnNames="id"
                                 referencedTableSchemaName="td"/>

        <createIndex tableName="reponse"
                     indexName="idx_reponse_question_id"
                     schemaName="td">
            <column name="question_id"/>
        </createIndex>

        <addForeignKeyConstraint baseTableName="reponse"
                                 baseColumnNames="correcteur_id"
                                 baseTableSchemaName="td"
                                 constraintName="fk_reponse_correcteur_id"
                                 referencedTableName="personne"
                                 referencedColumnNames="id"
                                 referencedTableSchemaName="ent"/>

        <createIndex tableName="reponse"
                     indexName="idx_reponse_correcteur_id"
                     schemaName="td">
            <column name="correcteur_id"/>
        </createIndex>

        <createSequence sequenceName="seance_id_seq"
                        schemaName="td" startValue="100"/>

        <createTable tableName="modalite_activite" schemaName="td">
            <column name="id" type="bigint">
                <constraints primaryKey="true"/>
            </column>
            <column name="date_echeance_remises"
                    type="timestamp without time zone">
                <constraints nullable="false"/>
            </column>
            <column name="date_debut" type="timestamp without time zone"/>
            <column name="date_fin" type="timestamp without time zone"/>
            <column name="etablissement_id" type="bigint"/>
            <column name="responsable_id" type="bigint"/>
            <column name="groupe_id" type="bigint"/>
            <column name="enseignant_id" type="bigint"/>
            <column name="service_id" type="bigint"/>
            <column name="activite_id" type="bigint"/>
            <column name="evaluation_id" type="bigint"/>

        </createTable>

        <addForeignKeyConstraint baseTableName="modalite_activite"
                                 baseColumnNames="evaluation_id"
                                 baseTableSchemaName="td"
                                 constraintName="fk_modalite_activite_evaluation_id"
                                 referencedTableName="evaluation"
                                 referencedColumnNames="id"
                                 referencedTableSchemaName="entnotes"/>

        <createIndex tableName="modalite_activite"
                     indexName="idx_modalite_activite_evaluation_id"
                     schemaName="td">
            <column name="evaluation_id"/>
        </createIndex>

        <addForeignKeyConstraint baseTableName="modalite_activite"
                                 baseColumnNames="activite_id"
                                 baseTableSchemaName="td"
                                 constraintName="fk_modalite_activite_activite_id"
                                 referencedTableName="activite"
                                 referencedColumnNames="id"
                                 referencedTableSchemaName="entcdt"/>

        <createIndex tableName="modalite_activite"
                     indexName="idx_modalite_activite_activite_id"
                     schemaName="td">
            <column name="activite_id"/>
        </createIndex>

        <addForeignKeyConstraint baseTableName="modalite_activite"
                                 baseColumnNames="service_id"
                                 baseTableSchemaName="td"
                                 constraintName="fk_modalite_activite_service_id"
                                 referencedTableName="service"
                                 referencedColumnNames="id"
                                 referencedTableSchemaName="ent"/>

        <createIndex tableName="modalite_activite"
                     indexName="idx_modalite_activite_service_id"
                     schemaName="td">
            <column name="service_id"/>
        </createIndex>

        <addForeignKeyConstraint baseTableName="modalite_activite"
                                 baseColumnNames="enseignant_id"
                                 baseTableSchemaName="td"
                                 constraintName="fk_modalite_activite_enseignant_id"
                                 referencedTableName="personne"
                                 referencedColumnNames="id"
                                 referencedTableSchemaName="ent"/>

        <createIndex tableName="modalite_activite"
                     indexName="idx_modalite_activite_enseignant_id"
                     schemaName="td">
            <column name="enseignant_id"/>
        </createIndex>

        <addForeignKeyConstraint baseTableName="modalite_activite"
                                 baseColumnNames="etablissement_id"
                                 baseTableSchemaName="td"
                                 constraintName="fk_modalite_activite_etablissement_id"
                                 referencedTableName="etablissement"
                                 referencedColumnNames="id"
                                 referencedTableSchemaName="ent"/>

        <createIndex tableName="modalite_activite"
                     indexName="idx_modalite_activite_etablissement_id"
                     schemaName="td">
            <column name="etablissement_id"/>
        </createIndex>

        <addForeignKeyConstraint baseTableName="modalite_activite"
                                 baseColumnNames="responsable_id"
                                 baseTableSchemaName="td"
                                 constraintName="fk_modalite_activite_responsable_id"
                                 referencedTableName="personne"
                                 referencedColumnNames="id"
                                 referencedTableSchemaName="ent"/>

        <createIndex tableName="modalite_activite"
                     indexName="idx_modalite_activite_responsable_id"
                     schemaName="td">
            <column name="responsable_id"/>
        </createIndex>

        <addForeignKeyConstraint baseTableName="modalite_activite"
                                 baseColumnNames="groupe_id"
                                 baseTableSchemaName="td"
                                 constraintName="fk_modalite_activite_groupe_id"
                                 referencedTableName="groupe_personnes"
                                 referencedColumnNames="id"
                                 referencedTableSchemaName="ent"/>

        <createIndex tableName="modalite_activite"
                     indexName="idx_modalite_activite_groupe_id"
                     schemaName="td">
            <column name="groupe_id"/>
        </createIndex>

        <addColumn tableName="copie" schemaName="td">
            <column name="modalite_activite_id" type="bigint"/>
        </addColumn>

        <addForeignKeyConstraint baseTableName="copie"
                                 baseColumnNames="modalite_activite_id"
                                 baseTableSchemaName="td"
                                 constraintName="fk_copie_modalite_activite_id"
                                 referencedTableName="modalite_activite"
                                 referencedColumnNames="id"
                                 referencedTableSchemaName="td"/>

        <createIndex tableName="copie"
                     indexName="idx_copie_modalite_activite_id"
                     schemaName="td">
            <column name="modalite_activite_id"/>
        </createIndex>

    </changeSet>

    <changeSet id="6" author="fsil">
        <comment>Ajout colonne code dans table export_format</comment>
        <addColumn tableName="export_format" schemaName="tice">
            <column name="code" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="7" author="fsil">
        <comment>
            Modification table copyrights_type
        </comment>
        <modifyDataType tableName="copyrigths_type" schemaName="tice"
                        columnName="logo"
                        newDataType="text"/>
    </changeSet>

    <changeSet id="8" author="fsil">
        <comment>
            Modification non table copyrights_type
        </comment>
        <renameTable oldTableName="copyrigths_type"
                     newTableName="copyrights_type"
                     schemaName="tice"/>
    </changeSet>

    <changeSet id="9" author="fsil">
        <comment>
            Modification contrainte not null sur publication.date_fin
        </comment>
        <dropNotNullConstraint tableName="publication"
                               columnName="date_fin" schemaName="tice"/>
    </changeSet>

    <changeSet id="10" author="fsil">
        <comment>
            Ajout champ note_correcteur dans td.copie et td.reponse
            Suppression not null contrainte sur td.copie.date_remise
            Ajout champ eleve_id sur td.reponse
            Ajout champ annotation_privee sur td.sujet
        </comment>

        <addColumn tableName="copie" schemaName="td">
            <column name="correction_note_correcteur" type="float"/>
            <column name="correction_note_non_numerique" type="varchar(255)"/>
        </addColumn>
        <dropNotNullConstraint tableName="copie" schemaName="td"
                               columnName="date_remise"/>

        <addColumn tableName="reponse" schemaName="td">
            <column name="correction_note_correcteur" type="float"/>
            <column name="correction_note_non_numerique" type="varchar(255)"/>
            <column name="eleve_id" type="bigint"/>
        </addColumn>

        <addForeignKeyConstraint baseTableName="reponse"
                                 baseColumnNames="eleve_id"
                                 baseTableSchemaName="td"
                                 constraintName="fk_reponse_eleve_id"
                                 referencedTableName="personne"
                                 referencedColumnNames="id"
                                 referencedTableSchemaName="ent"/>

        <createIndex tableName="reponse"
                     indexName="idx_reponse_eleve_id"
                     schemaName="td">
            <column name="eleve_id"/>
        </createIndex>

        <addUniqueConstraint tableName="reponse"
                             columnNames="copie_id, question_id"
                             schemaName="td"
                             constraintName="uk_reponse_copie_id_question_id"/>

        <addColumn tableName="sujet" schemaName="td">
            <column name="annotation_privee" type="text"/>
        </addColumn>

    </changeSet>

    <changeSet id="11" author="fsil">
        <comment>
            Correction sur orthographe copyrights
        </comment>
        <dropSequence sequenceName="copyrigths_type_id_seq" schemaName="tice"/>
        <createSequence sequenceName="copyrights_type_id_seq" schemaName="tice"
                        startValue="100"/>

        <renameColumn tableName="publication" oldColumnName="copyrigths_type_id"
                      newColumnName="copyrights_type_id" schemaName="tice"/>

    </changeSet>


    <changeSet id="12" author="fsil">
        <comment>Complément table sujet</comment>
        <addColumn tableName="sujet" schemaName="td">
            <column name="copyrights_type_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="acces_public" type="boolean">
                <constraints nullable="false"/>
            </column>
            <column name="acces_sequentiel" type="boolean">
                <constraints nullable="false"/>
            </column>
            <column name="ordre_questions_aleatoire" type="boolean">
                <constraints nullable="false"/>
            </column>
        </addColumn>

        <createIndex tableName="sujet" indexName="idx_sujet_copyrights_id"
                     schemaName="td">
            <column name="copyrights_type_id"/>
        </createIndex>

        <addForeignKeyConstraint baseTableName="sujet"
                                 baseColumnNames="copyrights_type_id"
                                 baseTableSchemaName="td"
                                 constraintName="fk_sujet_copyrights_id"
                                 referencedTableName="copyrights_type"
                                 referencedColumnNames="id"
                                 referencedTableSchemaName="tice"/>

    </changeSet>

    <changeSet id="13" author="fsil">
        <comment>
            Ajout de champs normalisés pour recherche sur sujets et questions
        </comment>
        <addColumn tableName="sujet" schemaName="td">
            <column name="titre_normalise" type="text"/>
            <column name="presentation_normalise" type="text"/>
        </addColumn>

        <addColumn tableName="question" schemaName="td">
            <column name="titre_normalise" type="text"/>
        </addColumn>
    </changeSet>

    <changeSet id="14" author="fsil">
        <comment>
            Ajout de champs "publies" pour optimiser recherche
        </comment>
        <addColumn tableName="sujet" schemaName="td">
            <column name="publie" type="boolean" defaultValue="false">
                <constraints nullable="false"/>
            </column>
        </addColumn>

        <addColumn tableName="question" schemaName="td">
            <column name="publie" type="boolean" defaultValue="false">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="15" author="fsil">
        <comment>
            Ajout des champs pour la gestion automatique du "timestamping"
            Ajout des champs pour gestion des version
        </comment>
        <addColumn tableName="sujet" schemaName="td">
            <column name="date_created"
                    type="timestamp without time zone"></column>
            <column name="last_updated"
                    type="timestamp without time zone"></column>
            <column name="sujet_derniere_version_id" type="bigint"/>
        </addColumn>

        <addColumn tableName="question" schemaName="td">
            <column name="date_created"
                    type="timestamp without time zone"></column>
            <column name="last_updated"
                    type="timestamp without time zone"></column>
            <column name="question_derniere_version_id" type="bigint"/>
        </addColumn>

        <addForeignKeyConstraint baseTableName="sujet"
                                 baseColumnNames="sujet_derniere_version_id"
                                 baseTableSchemaName="td"
                                 constraintName="fk_sujet_sujet_derniere_version_id"
                                 referencedTableName="sujet"
                                 referencedColumnNames="id"
                                 referencedTableSchemaName="td"/>

        <addForeignKeyConstraint baseTableName="question"
                                 baseColumnNames="question_derniere_version_id"
                                 baseTableSchemaName="td"
                                 constraintName="fk_question_question_derniere_version_id"
                                 referencedTableName="question"
                                 referencedColumnNames="id"
                                 referencedTableSchemaName="td"/>

        <addUniqueConstraint tableName="sujet"
                             columnNames="sujet_derniere_version_id, version_sujet"
                             schemaName="td"
                             constraintName="uk_sujet_version_sujet_derniere_version"/>

        <addUniqueConstraint tableName="question"
                             columnNames="question_derniere_version_id, version_question"
                             schemaName="td"
                             constraintName="uk_question_version_question_derniere_version"/>

        <createIndex tableName="sujet" schemaName="td"
                     indexName="idx_sujet_sujet_derniere_version_id">
            <column name="sujet_derniere_version_id"></column>
        </createIndex>

        <createIndex tableName="question" schemaName="td"
                     indexName="idx_question_question_derniere_version_id">
            <column name="question_derniere_version_id"></column>
        </createIndex>

    </changeSet>

    <changeSet id="16" author="fsil">
        <comment>Support des types de sujet</comment>

        <createTable tableName="sujet_type" schemaName="td">
            <column name="id" type="bigint">
                <constraints primaryKey="true"/>
            </column>
            <column name="nom" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="nom_anglais" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createSequence sequenceName="sujet_type_id_seq"
                        schemaName="td" startValue="100"/>

        <addColumn tableName="sujet" schemaName="td">
            <column name="sujet_type_id" type="bigint"/>
        </addColumn>

        <addForeignKeyConstraint baseTableName="sujet"
                                 baseColumnNames="sujet_type_id"
                                 constraintName="fk_sujet_sujet_type_id"
                                 referencedTableName="sujet_type"
                                 referencedColumnNames="id"
                                 baseTableSchemaName="td"
                                 referencedTableSchemaName="td"/>

        <createIndex tableName="sujet" schemaName="td"
                     indexName="idx_sujet_sujet_type_id">
            <column name="sujet_type_id"/>
        </createIndex>


    </changeSet>

    <changeSet id="17" author="fsil">
        <comment>
            Ajout de la colonne "code" sur table question_type
        </comment>
        <addColumn tableName="question_type" schemaName="td">
            <column name="code" type="varchar(255)" defaultValue="Undefined">
                <constraints nullable="false"/>
            </column>
            <column name="interaction" type="boolean" defaultValue="true">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="18" author="fsil">
        <comment>Complément table question</comment>
        <addColumn tableName="question" schemaName="td">
            <column name="copyrights_type_id" type="bigint">
                <constraints nullable="false"/>
            </column>
        </addColumn>

        <createIndex tableName="question" indexName="idx_question_copyrights_id"
                     schemaName="td">
            <column name="copyrights_type_id"/>
        </createIndex>

        <addForeignKeyConstraint baseTableName="question"
                                 baseColumnNames="copyrights_type_id"
                                 baseTableSchemaName="td"
                                 constraintName="fk_question_copyrights_id"
                                 referencedTableName="copyrights_type"
                                 referencedColumnNames="id"
                                 referencedTableSchemaName="tice"/>

    </changeSet>

    <changeSet id="19" author="fsil">
        <comment>
            Ajout de champs normalisés pour recherche sur questions
        </comment>

        <addColumn tableName="question" schemaName="td">
            <column name="specification_normalise" type="text"/>
        </addColumn>
    </changeSet>

    <changeSet id="20" author="fsil">
        <comment>
            Modification tables sujet et question pour gestion des versions
        </comment>
        <dropColumn tableName="sujet" columnName="sujet_derniere_version_id"
                    schemaName="td"/>
        <dropColumn tableName="question"
                    columnName="question_derniere_version_id" schemaName="td"/>

        <addColumn tableName="sujet"
                   schemaName="td">
            <column name="sujet_depart_branche_id" type="bigint"/>
        </addColumn>

        <addColumn tableName="question"
                   schemaName="td">
            <column name="question_depart_branche_id" type="bigint"/>
        </addColumn>

        <addForeignKeyConstraint baseTableName="sujet"
                                 baseColumnNames="sujet_depart_branche_id"
                                 baseTableSchemaName="td"
                                 constraintName="fk_sujet_sujet_depart_branche_id"
                                 referencedTableName="sujet"
                                 referencedColumnNames="id"
                                 referencedTableSchemaName="td"/>

        <addForeignKeyConstraint baseTableName="question"
                                 baseColumnNames="question_depart_branche_id"
                                 baseTableSchemaName="td"
                                 constraintName="fk_question_question_depart_branche_id"
                                 referencedTableName="question"
                                 referencedColumnNames="id"
                                 referencedTableSchemaName="td"/>

        <addUniqueConstraint tableName="sujet"
                             columnNames="sujet_depart_branche_id, version_sujet, proprietaire_id"
                             schemaName="td"
                             constraintName="uk_sujet_version_sujet_depart_branche"/>

        <addUniqueConstraint tableName="question"
                             columnNames="question_depart_branche_id, version_question, proprietaire_id"
                             schemaName="td"
                             constraintName="uk_question_version_question_depart_branche"/>

    </changeSet>

    <changeSet id="21" author="fsil">
        <comment>
            Suppression de quelques clés uniques sur les tables
            de jointures
        </comment>

        <dropUniqueConstraint tableName="question_arborescence"
                              constraintName="uk_question_arborescence_question_id_question_fille_id"
                              schemaName="td"/>

        <dropUniqueConstraint tableName="question_attachement"
                              constraintName="uk_question_attachement_question_id_attachement_id"
                              schemaName="td"/>

        <dropUniqueConstraint tableName="sujet_sequence_questions"
                              constraintName="uk_sujet_sequence_questions_question_id_sujet_id"
                              schemaName="td"/>


    </changeSet>

    <changeSet id="22" author="fsil">
        <comment>
            Ajout colonne sur table attachement
        </comment>
        <addColumn tableName="attachement" schemaName="tice">
            <column name="nom_fichier_original" type="varchar(255)"/>
        </addColumn>
    </changeSet>

    <changeSet id="23" author="fsil">
        <comment>
            Renommage et ajout colonne sur table attachement
        </comment>
        <addColumn tableName="attachement" schemaName="tice">
            <column name="a_supprimer" type="boolean" defaultValue="false"/>
        </addColumn>
        <renameColumn tableName="attachement"
                      oldColumnName="taille_en_ko"
                      newColumnName="taille" schemaName="tice"/>
    </changeSet>

    <changeSet id="24" author="fsil">
        <comment>Renommage colonne rang dans table sujet_sequence_question
        </comment>
        <renameColumn tableName="sujet_sequence_questions" oldColumnName="rang"
                      newColumnName="questions_sequences_idx" schemaName="td"/>
    </changeSet>

    <changeSet id="25" author="fsil">
        <comment>Modifications relatives à la table modalite_activite</comment>
        <createSequence sequenceName="modalite_activite_id_seq" schemaName="td"
                        startValue="100"/>
        <dropSequence sequenceName="seance_id_seq" schemaName="td"/>

        <renameColumn tableName="modalite_activite"
                      oldColumnName="date_echeance_remises"
                      newColumnName="date_remise_reponses" schemaName="td"/>
        <addNotNullConstraint tableName="modalite_activite"
                              columnName="date_debut"
                              schemaName="td"/>
        <addNotNullConstraint tableName="modalite_activite"
                              columnName="date_fin"
                              schemaName="td"/>
        <addNotNullConstraint tableName="modalite_activite"
                              columnName="enseignant_id"
                              schemaName="td"/>

        <addColumn tableName="modalite_activite" schemaName="td">
            <column name="sujet_id" type="bigint">
                <constraints nullable="false"/>
            </column>
        </addColumn>

        <createIndex tableName="modalite_activite"
                     indexName="idx_modalite_activite_sujet_id" schemaName="td">
            <column name="sujet_id"/>
        </createIndex>

        <addForeignKeyConstraint baseTableName="modalite_activite"
                                 baseColumnNames="sujet_id"
                                 constraintName="fk_modalite_activite_sujet_id"
                                 referencedTableName="sujet"
                                 referencedColumnNames="id"
                                 baseTableSchemaName="td"
                                 referencedTableSchemaName="td"/>

    </changeSet>

    <changeSet id="26" author="fsil">
        <comment>Ajout colonne copie améliorable</comment>
        <addColumn tableName="modalite_activite" schemaName="td">
            <column name="copie_ameliorable" type="boolean" defaultValue="true">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="27" author="fsil">
        <comment>
            Supprime not null constrainte sur modalite_activite.etablissement
        </comment>
        <dropNotNullConstraint tableName="modalite_activite"
                               columnName="etablissement_id" schemaName="td"/>
    </changeSet>

    <changeSet id="28" author="fsil">
        <comment>Modifications relatives à la table modalite_activite</comment>

        <addColumn tableName="modalite_activite" schemaName="td">
            <column name="structure_enseignement_id" type="bigint"/>
            <column name="matiere_id" type="bigint"/>
        </addColumn>

        <createIndex tableName="modalite_activite"
                     indexName="idx_modalite_activite_structure_id"
                     schemaName="td">
            <column name="structure_enseignement_id"/>
        </createIndex>

        <createIndex tableName="modalite_activite"
                     indexName="idx_modalite_activite_matiere_id"
                     schemaName="td">
            <column name="matiere_id"/>
        </createIndex>

        <addForeignKeyConstraint baseTableName="modalite_activite"
                                 baseColumnNames="structure_enseignement_id"
                                 constraintName="fk_modalite_activite_structure_enseignement_id"
                                 referencedTableName="structure_enseignement"
                                 referencedColumnNames="id"
                                 baseTableSchemaName="td"
                                 referencedTableSchemaName="ent"/>

        <addForeignKeyConstraint baseTableName="modalite_activite"
                                 baseColumnNames="matiere_id"
                                 constraintName="fk_modalite_activite_matiere_id"
                                 referencedTableName="matiere"
                                 referencedColumnNames="id"
                                 baseTableSchemaName="td"
                                 referencedTableSchemaName="ent"/>

        <dropColumn tableName="modalite_activite" columnName="service_id"
                    schemaName="td"/>

    </changeSet>

    <changeSet id="29" author="fsil">
        <comment>
            Ajout de la colonne sujet_sequence_questions.points
        </comment>
        <addColumn tableName="sujet_sequence_questions" schemaName="td">
            <column name="points" defaultValue="1" type="float">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="30" author="fsil">
        <comment>
            Correction table reponse
            Ajout de contraintes d'unicité sur table copie et reponse
        </comment>
        <dropColumn tableName="reponse" columnName="question_id"
                    schemaName="td"/>
        <addColumn tableName="reponse" schemaName="td">
            <column name="sujet_question_id" type="bigint">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <createIndex tableName="reponse"
                     indexName="idx_reponse_sujet_question_id" schemaName="td">
            <column name="sujet_question_id"/>
        </createIndex>
        <addForeignKeyConstraint baseTableName="reponse"
                                 baseColumnNames="sujet_question_id"
                                 constraintName="fk_reponse_sujet_question_id"
                                 referencedTableName="sujet_sequence_questions"
                                 referencedColumnNames="id"
                                 baseTableSchemaName="td"
                                 referencedTableSchemaName="td"/>

        <addUniqueConstraint tableName="copie"
                             columnNames="modalite_activite_id,eleve_id"
                             constraintName="uk_copie_seance_eleve"
                             schemaName="td"/>

         <addUniqueConstraint tableName="reponse"
                             columnNames="sujet_question_id,copie_id"
                             constraintName="uk_reponse_copie_question"
                             schemaName="td"/>

    </changeSet>

</databaseChangeLog>